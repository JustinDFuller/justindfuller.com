<!DOCTYPE html>
<html class="no-js" lang="">
  <head>
    <meta charset="utf-8" />
    <title>Grass | Justin Fuller</title>
    <meta name="description" content="Grass | Justin Fuller" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <meta property="og:title" content="Grass | Justin Fuller" />

    <link rel="icon" href="/image/grass.ico" sizes="any" />
    <link rel="icon" href="/image/grass.svg" type="image/svg+xml" />
    <link rel="apple-touch-icon" href="/image/grass-apple-touch-icon.png" />

    <link rel="manifest" href="/grass.webmanifest" />
    <meta name="theme-color" content="#fafafa" />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Amiri&display=swap"
      rel="stylesheet"
    />

    <style>
      * {
        box-sizing: border-box;
      }

      html,
      body {
        padding: 0 20px;
        margin: 0;
        width: 100%;
        height: max-content;
        display: block;
        font-size: 24px;
        font-family: "Amiri", serif;
        background: #fcf9f4;
      }

      #getLocation {
        margin-top: 40px;
        margin-bottom: 40px;
      }

      .centered {
        margin-left: auto;
        margin-right: auto;
        display: block;
      }

      div {
        width: 100%;
      }

      @keyframes fadeIn {
        0% {
          opacity: 0;
        }
        100% {
          opacity: 1;
        }
      }

      main {
        animation: fadeIn 1s;
        height: max-content;
        max-width: 500px;
        margin: auto;
        display: flex;
        justify-content: flex-start;
        align-items: center;
        flex-direction: column;
        padding-bottom: 60px;
      }

      h1 {
        line-height: 45px;
        margin-top: 40px;
        margin-bottom: 20px;
      }

      button,
      p,
      progress {
        margin: 20px 0;
      }

      select {
        width: 100%;
        padding: 10px 20px;
        border: 2px solid black;
        background: white;
        color: black;
      }

      button {
        padding: 10px 20px;
        border-top: 2px solid black;
        border-left: 2px solid black;
        border-right: 4px solid black;
        border-bottom: 4px solid black;
        border-radius: 2px;
        background: white;
        color: black;
        cursor: pointer;
      }

      button:hover {
        border-top: 3px solid black;
        border-left: 3px solid black;
        border-right: 3px solid black;
        border-bottom: 3px solid black;
      }

      select,
      label,
      input[type="checkbox"] {
        cursor: pointer;
      }

      label {
        display: block;
      }

      #weekDays.hidden,
      .hidden {
        display: none;
      }

      #weekDays {
        display: flex;
        flex-direction: row;
        justify-content: space-between;
        flex-wrap: wrap;
        align-items: flex-start;
      }

      .day {
        background: white;
        cursor: pointer;
        text-align: center;
        width: 45%;
        border-top: 2px solid black;
        border-left: 2px solid black;
        border-right: 4px solid black;
        border-bottom: 4px solid black;
        border-radius: 4px;
        margin-bottom: 20px;
      }

      .day:has(input:checked) {
        border-color: #0075ff;
      }

      @media screen and (max-width: 400px) {
        .day {
          width: 100%;
        }
      }

      .day:hover {
        border-right: 3px solid black;
        border-bottom: 3px solid black;
        border-left: 3px solid black;
        border-top: 3px solid black;
      }

      .day .icon {
        height: 40px;
        width: auto;
      }

      .day .icon.thermometer {
        padding-bottom: 5px;
        margin-left: -10px;
      }

      .day .icon.cloud {
        padding-bottom: 2px;
        margin-left: -10px;
      }

      .day .stat {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .day .title {
        display: block;
        text-align: center;
        font-weight: bold;
      }

      .day .rain,
      .day .temperature {
        min-width: 70px;
      }
    </style>
  </head>

  <body>
    <main>
      <h1>Grass</h1>
      <p id="intro">
        Hey there ðŸ‘‹ I'd like to help you figure out how much to water your
        grass. This is trickier than it may seem. The amount changes based on
        the grass type and natural rainfall. Overwatering wastes resources;
        hurts your grass; and may cause mold, fungus, and moss to grow in your
        yard. Underwatering will cause your grass to go dormant and eventually
        die.
        <br />
        <br />
        To combat these problems, I'll use your area's forecast along with some
        information about your lawn's grass to create a custom watering plan.
        <br />
        <br />
        To get started, click the button below to grant the page access to your
        latitude and longitude. I'll send this over to
        <a href="https://www.weather.gov/documentation/services-web-api"
          >weather.gov</a
        >
        to get your seven day forecast.

        <button
          id="getLocation"
          class="centered"
          onclick="handleLocationClick()"
        >
          Grant Access to Location & Begin
        </button>
      </p>

      <div id="loading" class="hidden">
        Loading your seven-day forecast from
        <a href="https://www.weather.gov/documentation/services-web-api"
          >weather.gov</a
        >. This may take a few moments.
        <progress id="loading" class="centered" aria-hidden="true"></progress>
      </div>
      <div id="precipitation" class="hidden">
        <p>
          Your forecast predicts
          <span id="precipitationTotalInches">?</span>
          inches of rain during the next next seven days.
        </p>
      </div>
      <div id="chooseGrassType" class="hidden">
        <select id="chooseGrassTypeSelect" onchange="handleGrassSelect(this)">
          <option selected="" disabled="" value="">Select a Grass Type</option>
          <option value="Bermuda">Bermuda</option>
          <option value="Zoysia">Zoysia</option>
          <option value="St. Augustine">St. Augustine</option>
          <option value="Kentucky Bluegrass">Kentucky Bluegrass</option>
          <option value="Tall Fescue">Tall Fescue</option>
          <option value="Ryegrass">Ryegrass</option>
          <option value="Fine Fescue">Fine Fescue</option>
        </select>
      </div>
      <div id="wateringNeeds" class="hidden">
        <p>
          Based on your grass type, you need
          <span id="wateringNeedsAmount">?</span>
          <span id="wateringNeedsInches">inches</span>
          of water each week.
          <strong>
            Water three days this week for
            <span id="wateringMinutesEachDay">?</span>
            minutes each day.
          </strong>
          This will make up the remaining
          <span id="wateringDeficiency">?</span>
          inches.
        </p>
      </div>
      <div id="weekDayPrompt" class="hidden">
        <p>
          I've gone ahead and suggested the three optimal days to water your
          grass based on the projected rainfall and temperature. Feel free to
          choose different days, though.
        </p>
      </div>
      <div id="weekDays" class="hidden">
        <label for="sundayCheckbox" id="Sunday" class="day">
          <span class="title">Sunday</span>
          <div class="stat">
            <img class="icon thermometer" src="/image/temperature.png" />
            <span class="temperature"></span>
          </div>
          <div class="stat">
            <img class="icon cloud" src="/image/rain.png" />
            <span class="rain"></span>
          </div>
          <div>
            <input
              id="sundayCheckbox"
              type="checkbox"
              name="Sunday"
              onchange="handleWaterLawnCheck(this)"
            />
          </div>
        </label>
        <label for="mondayCheckbox" id="Monday" class="day">
          <span class="title">Monday</span>
          <div class="stat">
            <img class="icon thermometer" src="/image/temperature.png" />
            <span class="temperature"></span>
          </div>
          <div class="stat">
            <img class="icon cloud" src="/image/rain.png" />
            <span class="rain"></span>
          </div>
          <div>
            <input
              id="mondayCheckbox"
              type="checkbox"
              name="Monday"
              onchange="handleWaterLawnCheck(this)"
            />
          </div>
        </label>
        <label for="tuesdayCheckbox" id="Tuesday" class="day">
          <span class="title">Tuesday</span>
          <div class="stat">
            <img class="icon thermometer" src="/image/temperature.png" />
            <span class="temperature"></span>
          </div>
          <div class="stat">
            <img class="icon cloud" src="/image/rain.png" />
            <span class="rain"></span>
          </div>
          <div>
            <input
              id="tuesdayCheckbox"
              type="checkbox"
              name="Tuesday"
              onchange="handleWaterLawnCheck(this)"
            />
          </div>
        </label>
        <label for="wednesdayCheckbox" id="Wednesday" class="day">
          <span class="title">Wednesday</span>
          <div class="stat">
            <img class="icon thermometer" src="/image/temperature.png" />
            <span class="temperature"></span>
          </div>
          <div class="stat">
            <img class="icon cloud" src="/image/rain.png" />
            <span class="rain"></span>
          </div>
          <div>
            <input
              id="wednesdayCheckbox"
              type="checkbox"
              name="Wednesday"
              onchange="handleWaterLawnCheck(this)"
            />
          </div>
        </label>
        <label for="thursdayCheckbox" id="Thursday" class="day">
          <span class="title">Thursday</span>
          <div class="stat">
            <img class="icon thermometer" src="/image/temperature.png" />
            <span class="temperature"></span>
          </div>
          <div class="stat">
            <img class="icon cloud" src="/image/rain.png" />
            <span class="rain"></span>
          </div>
          <div>
            <input
              id="thursdayCheckbox"
              type="checkbox"
              name="Thursday"
              onchange="handleWaterLawnCheck(this)"
            />
          </div>
        </label>
        <label for="fridayCheckbox" id="Friday" class="day">
          <span class="title">Friday</span>
          <div class="stat">
            <img class="icon thermometer" src="/image/temperature.png" />
            <span class="temperature"></span>
          </div>
          <div class="stat">
            <img class="icon cloud" src="/image/rain.png" />
            <span class="rain"></span>
          </div>
          <div>
            <input
              id="fridayCheckbox"
              type="checkbox"
              name="Friday"
              onchange="handleWaterLawnCheck(this)"
            />
          </div>
        </label>
        <label for="saturdayCheckbox" id="Saturday" class="day">
          <span class="title">Saturday</span>
          <div class="stat">
            <img class="icon thermometer" src="/image/temperature.png" />
            <span class="temperature"></span>
          </div>
          <div class="stat">
            <img class="icon cloud" src="/image/rain.png" />
            <span class="rain"></span>
          </div>
          <div>
            <input
              id="saturdayCheckbox"
              type="checkbox"
              name="Saturday"
              onchange="handleWaterLawnCheck(this)"
            />
          </div>
        </label>
      </div>
      <div id="notifications">
        If you want, I can remind you to water your lawn on these days.

        <button class="centered" onclick="handleReminderClick()">
          Sounds good. Set up reminders.
        </button>
      </div>
    </main>

    <!-- Simple script to hide main until fonts are loaded -->
    <script>
      if ('serviceworker' in navigator) {
        navigator.serviceWorker.register('/grass/service-worker.js');
      }

      const main = document.querySelector("main");
      main.style.visibility = "hidden";
      document.fonts.ready.then(function () {
        main.style.visibility = "visible";
      });

      const week = [
        "Sunday",
        "Monday",
        "Tuesday",
        "Wednesday",
        "Thursday",
        "Friday",
        "Saturday",
      ];

      const grassTypes = [
        {
          name: "Bermuda",
          inches: 1,
        },
        {
          name: "Zoysia",
          inches: 0.75,
        },
        {
          name: "St. Augustine",
          inches: 1.25,
        },
        {
          name: "Kentucky Bluegrass",
          inches: 2.5,
        },
        {
          name: "Tall Fescue",
          inches: 1.5,
        },
        {
          name: "Ryegrass",
          inches: 1.25,
        },
        {
          name: "Fine Fescue",
          inches: 1,
        },
      ];

      const intro = document.getElementById("intro");
      const loading = document.getElementById("loading");
      const precipitation = document.getElementById("precipitation");
      const precipitationTotalInches = document.getElementById(
        "precipitationTotalInches"
      );

      const chooseGrassType = document.getElementById("chooseGrassType");
      const chooseGrassTypeSelect = document.getElementById(
        "chooseGrassTypeSelect"
      );

      const wateringNeeds = document.getElementById("wateringNeeds");
      const wateringNeedsAmount = document.getElementById(
        "wateringNeedsAmount"
      );
      const wateringMinutesEachDay = document.getElementById(
        "wateringMinutesEachDay"
      );
      const wateringDeficiency = document.getElementById("wateringDeficiency");

      const forecast = {};

      async function handleLocationClick() {
        intro.classList.add("hidden");
        loading.classList.remove("hidden");

        const location = await new Promise(function (resolve) {
          navigator.geolocation.getCurrentPosition(async (position) => {
            const location = {
              latitude: position.coords.latitude,
              longitude: position.coords.longitude,
            };
            window.localStorage.setItem("location", JSON.stringify(location));
            resolve(location);
          });
        });

        renderForecast(location);
      }

      async function renderForecast(location) {
        intro.classList.add("hidden");
        loading.classList.remove("hidden");

        const point = await fetch(
          `https://api.weather.gov/points/${location.latitude},${location.longitude}`
        ).then((res) => res.json());

        const response = await fetch(point.properties.forecastGridData).then(
          (res) => res.json()
        );

        let total = 0;
        const days = {};

        for (const value of response.properties.quantitativePrecipitation
          .values) {
          total = (total * 100 + value.value * 100) / 100;

          const date = value.validTime.slice(0, 10);
          const parsed = new Date(
            Number(date.slice(0, 4)),
            Number(date.slice(5, 7)) - 1,
            Number(date.slice(8, 10))
          );

          const today = new Date()
          const sevenDays = new Date()
          sevenDays.setDate(today.getDate() + 7)
          if (parsed > sevenDays) {
            continue
          }

          let day = days[date];
          if (!day) {
            day = {
              date,
              day: week[parsed.getDay()],
              dayInt: parsed.getDay(),
              precipitationInches: 0,
              temperatureF: 0,
            };
          }
          day.precipitationInches += value.value / 25.4;
          days[date] = day;
        }

        for (const value of response.properties.maxTemperature.values) {
          const date = value.validTime.slice(0, 10);
          const parsed = new Date(
            Number(date.slice(0, 4)),
            Number(date.slice(5, 7)) - 1,
            Number(date.slice(8, 10))
          );

          const today = new Date()
          const sevenDays = new Date()
          sevenDays.setDate(today.getDate() + 7)
          if (parsed > sevenDays) {
            continue
          }

          let day = days[date];
          if (!day) {
            day = {
              date,
              day: week[parsed.getDay()],
              dayInt: parsed.getDay(),
              precipitationInches: 0,
              temperatureF: 0,
            };
          }
          day.temperatureF = Math.round((value.value * 1.8 + 32) * 100) / 100;
          days[date] = day;
        }

        total = Number(Math.round(total * 100) / 100).toFixed(2);

        const totalInches = (total / 25.4).toFixed(2);

        forecast.totalInches = totalInches;
        forecast.days = days;

        precipitationTotalInches.innerText = totalInches;
        precipitation.classList.remove("hidden");
        loading.classList.add("hidden");
        chooseGrassType.classList.remove("hidden");

        const selectedGrass = window.localStorage.getItem("grass") || "";
        if (selectedGrass) {
          chooseGrassTypeSelect.value = selectedGrass;
          handleGrassSelect({ value: selectedGrass });
        }
      }

      function handleGrassSelect(target) {
        const grass = grassTypes.find((g) => g.name === target.value);

        window.localStorage.setItem("grass", grass.name);
        const deficiency =
          Math.round((grass.inches - forecast.totalInches) * 100) / 100;
        const third = Math.round((deficiency / 3) * 100) / 100;

        wateringNeedsAmount.innerText = grass.inches;
        wateringMinutesEachDay.innerText = Math.round(60 * third);
        wateringDeficiency.innerText = deficiency;
        wateringNeeds.classList.remove("hidden");

        const sorted = Object.values(forecast.days).sort((a, b) => {
          if (a.precipitationInches === 0 && b.precipitationInches === 0) {
            return b.temperatureF - a.temperatureF;
          }
          return a.precipitationInches - b.precipitationInches
        }).map((val, index) => {
          if (index < 3) {
            val.willWater = true
          } else {
            val.willWater = false
          }

          return val
        })

        sorted.forEach(day => {
          forecast.days[day.date] = day

          if (day.willWater) {
            document
              .getElementById(day.day)
              .querySelector("input").checked = "checked"
          }
        })

        for (const date in forecast.days) {
          const day = forecast.days[date];

          const currentDay = new Date().getDay()

          let realDay = day.dayInt - currentDay
          if (realDay < 0) {
            realDay = 7 + realDay
          }

          document.getElementById(day.day).style.order = realDay

          if (day.dayInt === currentDay) {
            document
              .getElementById(day.day)
              .querySelector(".title").innerText = "Today"
          } else if (day.dayInt === (currentDay + 1)) {
            document
              .getElementById(day.day)
              .querySelector(".title").innerText = "Tomorrow"
          }

          document
            .getElementById(day.day)
            .querySelector(".rain").innerText = ( day.precipitationInches === 0 ? 0 : day.precipitationInches.toFixed(2)) + "in";

          document
            .getElementById(day.day)
            .querySelector(".temperature").innerText = day.temperatureF + "Â°F";

          document.getElementById("weekDays").classList.remove("hidden");
          document.getElementById("weekDayPrompt").classList.remove("hidden");
        }
      }

      function handleWaterLawnCheck(event) {
        for (const date in forecast.days) {
          const day = forecast.days[date];

          if (day.day !== event.name) {
            continue;
          }

          day.willWater = event.checked;
        }
      }

      async function handleReminderClick() {
        const reg = await navigator.serviceWorker.getRegistration();
        console.log(reg)

        Notification.requestPermission().then(permission => {
          if (permission !== 'granted') {
            alert('you need to allow push notifications');
          } else {
            const timestamp = new Date().getTime() + 5 * 1000; // now plus 5000ms
            reg.showNotification(
              'Demo Push Notification',
            {
              tag: timestamp, // a unique ID
              body: 'Hello World', // content of the push notification
              showTrigger: new TimestampTrigger(timestamp), // set the time for the push notification
              data: {
                url: window.location.href, // pass the current url to the notification
              },
              badge: './assets/badge.png',
              icon: './assets/icon.png',
            });
          }
        });
      }

      try {
        const location = window.localStorage.getItem("location");

        if (location) {
          parsed = JSON.parse(location);
          intro.classList.add("hidden");
          renderForecast(parsed);
        }
      } catch (e) {
        console.log(e);
      }
    </script>
  </body>
</html>
