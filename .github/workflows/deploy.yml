---

name: Build and Deploy to GAE

concurrency:
  group: gae-deploy
  cancel-in-progress: true

on:
  push:
    branches: ["main"]

jobs:
  setup-build-publish-deploy:
    name: Setup, Build, Publish, and Deploy
    runs-on: ubuntu-latest
    environment: production

    permissions:
      contents: read
      id-token: write
      checks: write

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          lfs: true

      - name: Checkout LFS
        run: git lfs checkout

      - name: Use Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20.x'

      - name: Install npm
        run: npm ci

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: "./go.mod"

      - name: "prep"
        run: |
          cp ./.appengine/app.yaml ./app.yaml
          echo "" >> ./app.yaml
          echo "service: default" >> ./app.yaml
          cp ./.appengine/dispatch.yaml ./dispatch.yaml

      - name: "auth"
        uses: "google-github-actions/auth@v3"
        with:
          credentials_json: "${{ secrets.GOOGLE_CREDENTIALS }}"

      - name: Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v3

      - name: Install App Engine Go component
        run: gcloud components install app-engine-go --quiet

      - name: "deploy"
        id: deploy
        uses: "google-github-actions/deploy-appengine@v3"
        with:
          project_id: "justindfuller"
          deliverables: "app.yaml dispatch.yaml"

      - name: Re-authenticate for cleanup
        if: ${{ success() }}
        id: auth-cleanup
        uses: "google-github-actions/auth@v3"
        with:
          credentials_json: "${{ secrets.GOOGLE_CREDENTIALS }}"
          create_credentials_file: true

      - name: Delete previous App Engine versions
        if: ${{ success() }}
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ steps.auth-cleanup.outputs.credentials_file_path }}
          CLOUDSDK_AUTH_CREDENTIAL_FILE_OVERRIDE: ${{ steps.auth-cleanup.outputs.credentials_file_path }}
        run: |
          NEW_VERSION="${{ steps.deploy.outputs.version_id }}"
          SERVICE="default"

          if [ -z "$NEW_VERSION" ]; then
            echo "No new version detected; skipping cleanup."
            exit 0
          fi

          echo "Cleaning up versions for service '${SERVICE}', keeping '${NEW_VERSION}' and the most recent previous version."

          PREVIOUS_VERSION="$(gcloud app versions list \
            --project=justindfuller \
            --service="${SERVICE}" \
            --sort-by=~version.createTime \
            --filter="NOT version.id=${NEW_VERSION}" \
            --format="value(version.id)" | head -n 1)"

          DELETE_LIST="$(gcloud app versions list \
            --project=justindfuller \
            --service="${SERVICE}" \
            --format="value(version.id)")"

          if [ -n "${PREVIOUS_VERSION}" ]; then
            DELETE_LIST="$(echo "${DELETE_LIST}" | grep -Fxv -e "${NEW_VERSION}" -e "${PREVIOUS_VERSION}" || true)"
          else
            DELETE_LIST="$(echo "${DELETE_LIST}" | grep -Fxv -e "${NEW_VERSION}" || true)"
          fi

          if [ -n "${PREVIOUS_VERSION}" ]; then
            echo "Keeping recent versions: ${NEW_VERSION} ${PREVIOUS_VERSION}"
          else
            echo "No previous version found; only current version will remain."
          fi

          if [ -z "$DELETE_LIST" ]; then
            echo "No previous versions to delete."
            exit 0
          fi

          echo "Deleting versions:"
          echo "${DELETE_LIST}"
          echo "${DELETE_LIST}" | xargs -r gcloud app versions delete \
            --project=justindfuller \
            --service="${SERVICE}" \
            --quiet
